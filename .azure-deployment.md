# Azure Deployment Guide

## Option 1: Deploy via Azure Portal (Recommended for Webhooks)

### Step 1: Create Azure App Service
1. Go to [Azure Portal](https://portal.azure.com)
2. Click **Create a resource**
3. Search for **App Service**
4. Click **Create**

### Step 2: Configure App Service
- **Name**: `insta-gemini-bot` (or your preferred name)
- **Runtime**: Python 3.10
- **Region**: Choose closest to you (e.g., East US, Southeast Asia)
- **Pricing**: Free or Basic tier

### Step 3: Configure Deployment
1. Go to **Deployment Center** in your App Service
2. Choose deployment source:
   - **GitHub** (recommended - automatic updates)
   - **Local Git** (manual updates)
3. Connect your GitHub account or enable Local Git

### Step 4: Configure Application Settings
1. Go to **Configuration** → **Application settings**
2. Add these variables:
   ```
   GEMINI_API_KEY = your_api_key_here
   INSTAGRAM_USERNAME = your_username
   INSTAGRAM_PASSWORD = your_password
   INSTAGRAM_PAGE_ACCESS_TOKEN = your_token
   VERIFY_TOKEN = your_verify_token
   DEBUG = False
   ```

### Step 5: Configure Startup Command
1. In **Configuration** → **General settings**
2. Set **Startup command**:
   ```
   gunicorn --workers 4 --bind 0.0.0.0:8000 --timeout 60 app:app
   ```

### Step 6: Test Your Webhook
1. Get your App Service URL (e.g., `https://insta-gemini-bot.azurewebsites.net`)
2. Set your Instagram Webhook URL to: `https://insta-gemini-bot.azurewebsites.net/webhook`
3. Set Verify Token to match `VERIFY_TOKEN` in Application Settings
4. Subscribe to `messages` events

---

## Option 2: Deploy via Azure Container (Docker)

### Step 1: Set up Azure Container Registry
```bash
az acr create --resource-group myResourceGroup --name myregistry --sku Basic
```

### Step 2: Build and Push Docker Image
```bash
az acr build --registry myregistry --image insta-bot:latest .
```

### Step 3: Deploy to Container Instances
```bash
az container create \
  --resource-group myResourceGroup \
  --name insta-bot \
  --image myregistry.azurecr.io/insta-bot:latest \
  --port 8000 \
  --environment-variables \
    GEMINI_API_KEY=<key> \
    INSTAGRAM_PAGE_ACCESS_TOKEN=<token> \
  --registry-login-server myregistry.azurecr.io \
  --registry-username <username> \
  --registry-password <password>
```

---

## Option 3: Fast Deploy via Azure CLI

```bash
# Login to Azure
az login

# Create Resource Group
az group create --name myResourceGroup --location eastus

# Create App Service Plan
az appservice plan create \
  --name myAppServicePlan \
  --resource-group myResourceGroup \
  --sku B1 --is-linux

# Create Web App
az webapp create \
  --resource-group myResourceGroup \
  --plan myAppServicePlan \
  --name insta-gemini-bot \
  --runtime "python|3.10" \
  --deployment-local-git

# Configure app settings
az webapp config appsettings set \
  --resource-group myResourceGroup \
  --name insta-gemini-bot \
  --settings \
    GEMINI_API_KEY="<your-key>" \
    INSTAGRAM_PAGE_ACCESS_TOKEN="<your-token>" \
    VERIFY_TOKEN="<your-token>"

# Set startup command
az webapp config set \
  --resource-group myResourceGroup \
  --name insta-gemini-bot \
  --startup-file "gunicorn --workers 4 --bind 0.0.0.0:8000 app:app"
```

---

## Important for Webhooks

- ✅ Your endpoint **must** be HTTPS (Azure App Service provides free SSL)
- ✅ Instagram webhooks require valid certificates (Azure provides these)
- ✅ Webhook timeout is **20 seconds** - ensure your Gemini API calls complete in time
- ✅ Set `max_output_tokens` appropriately to keep responses quick

## Monitoring

1. Go to **Monitor** → **Logs** to view real-time logs
2. Go to **Diagnose and solve problems** for debugging
3. Use Application Insights for detailed telemetry (optional)

## Costs

- **Free Tier**: App Service plan limited to 1GB RAM, 60 min/day
- **Basic B1**: ~$13/month - recommended for production bots
- **Standard S1**: ~$50/month - for high-traffic bots
